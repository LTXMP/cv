<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclusive Aim - User Dashboard</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #0f0f13;
            --card-bg: #1a1a20;
            --text: #ffffff;
            --text-dim: #a0a0a0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        h1,
        h2 {
            font-weight: 300;
            letter-spacing: 1px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Auth Wrapper */
        #auth-wrapper,
        #dashboard-wrapper {
            display: none;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Forms */
        input,
        select,
        button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #333;
            background: #25252b;
            color: white;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background-color: #444;
        }

        button.danger {
            background-color: #e74c3c;
        }

        /* Model List */
        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #222;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .tag {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .tag-public {
            background: #2ecc71;
            color: #000;
        }

        .tag-private {
            background: #e74c3c;
            color: white;
        }

        .tag-shared {
            background: #f1c40f;
            color: #000;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="nav">
            <h1>EXCLUSIVE<span>AIM</span></h1>
            <div id="userInfo" style="display:none">
                <span id="usernameDisplay">User</span>
                <button onclick="logout()" style="width: auto; margin-left:10px; padding: 5px 15px;">Logout</button>
            </div>
        </header>

        <!-- Auth View -->
        <div id="auth-wrapper">
            <div class="card">
                <h2>Login</h2>
                <input type="email" id="loginEmail" placeholder="Email Address">
                <input type="password" id="loginPass" placeholder="Password">
                <button onclick="login()">Login</button>
            </div>
            <div class="card">
                <h2>Register</h2>
                <input type="text" id="regUser" placeholder="Username (for sharing)">
                <input type="email" id="regEmail" placeholder="Email Address">
                <input type="password" id="regPass" placeholder="Password">
                <button onclick="register()" class="secondary">Create Account</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-wrapper">

            <!-- License Section -->
            <div class="card">
                <h2>License Key</h2>
                <p style="font-size: 0.9em; color: var(--text-dim);">Enter a key provided by the admin to unlock client
                    access.</p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="claimKeyInput" placeholder="Enter License Key">
                    <button onclick="claimKey()" style="width: 150px;">Claim</button>
                </div>
            </div>

            <!-- User Settings -->
            <div class="card">
                <h2>Settings</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <h3>Change Email</h3>
                        <input type="email" id="updateEmail" placeholder="New Email">
                        <button onclick="updateProfile('email')">Update Email</button>
                    </div>
                    <div>
                        <h3>Change Password</h3>
                        <input type="password" id="updatePass" placeholder="New Password">
                        <button onclick="updateProfile('password')">Update Password</button>
                    </div>
                    <div style="grid-column: span 2; margin-top: 10px; padding-top:10px; border-top: 1px solid #333">
                        <h3>Hardware ID</h3>
                        <p style="font-size:0.8em; color:#888">Resetting this allows you to use your license on a new
                            PC.</p>
                        <button onclick="resetHWID()" class="secondary">Reset HWID</button>
                    </div>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="adminPanel" class="card" style="display:none; border: 1px solid var(--primary);">
                <h2>ðŸ‘‘ Admin Panel</h2>

                <div style="margin-bottom: 20px;">
                    <h3>Generate License</h3>
                    <div style="display: flex; gap: 10px;">
                        <select id="genDuration">
                            <option value="LIFETIME">Lifetime</option>
                            <option value="2592000">30 Days</option>
                            <option value="86400">1 Day</option>
                        </select>
                        <button onclick="generateLicense()">Generate License Key</button>
                    </div>
                    <div id="adminOutput" style="margin-top: 10px; font-family: monospace; color: #2ecc71;"></div>
                </div>

                <div style="border-top: 1px solid #333; padding-top: 10px;">
                    <h3>Manage Users</h3>
                    <button onclick="loadUsers()" class="secondary" style="width: auto;">Refresh User List</button>
                    <div id="userList" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Model Upload -->
            <div class="card">
                <h2>Upload Model</h2>
                <input type="text" id="uploadName" placeholder="Model Name (e.g. V1 Legit)">
                <input type="file" id="uploadFile">
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <input type="checkbox" id="uploadPublic" style="width: 20px;"> Make Public
                </label>
                <button onclick="uploadModel()">Upload .enc / .onnx</button>
            </div>

            <!-- My Models -->
            <div class="card">
                <h2>My Models</h2>
                <div id="modelsList">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let currentUser = null;

        // --- Auth ---
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            const res = await fetch(`${API}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, password: p })
            });
            const data = await res.json();
            if (res.ok) {
                // If backend supports returning username/admin status on login
                // Ideally backend returns { message: "...", is_admin: true }
                // We might not get username, but we can trust the session check to fill it or 
                // just reload to trigger checkSession logic if we implemented a /me endpoint.
                // For now, let's just reload page to simple things.
                window.location.reload();
            } else {
                alert(data.error);
            }
        }

        async function register() {
            const u = document.getElementById('regUser').value;
            const e = document.getElementById('regEmail').value;
            const p = document.getElementById('regPass').value;
            const res = await fetch(`${API}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, email: e, password: p })
            });
            if (res.ok) {
                alert('Registered! Please login.');
            } else {
                alert((await res.json()).error);
            }
        }

        async function logout() {
            await fetch(`${API}/logout`, { method: 'POST' });
            window.location.reload();
        }

        async function checkSession() {
            // Simple session check by trying to fetch models
            const res = await fetch(`${API}/models`);
            if (res.ok) {
                // Determine if admin by trying verification or just UI hint
                // Since we don't have a dedicated /me, we'll assume not admin 
                // unless we can verify.
                // Actually, let's try to access admin endpoint to check? No.
                // Let's just default to user.

                // NOTE: To get username/admin properly, we should add /api/me.
                // But for now, let's just show dashboard.
                currentUser = { username: "User", isAdmin: false };
                showDashboard();

                // Lazy load admin check (optional)
            } else {
                showAuth();
            }
        }

        // --- Dashboard ---
        function showAuth() {
            document.getElementById('auth-wrapper').style.display = 'block';
            document.getElementById('dashboard-wrapper').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('auth-wrapper').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('usernameDisplay').textContent = "Welcome"; // Fallback since we don't have username

            // Show admin panel if we can... 
            // In this simple version we might hide it until verified or just keep it hidden.
            // Admin can login as 'admin' user.

            loadModels();
        }

        // --- Features ---
        async function claimKey() {
            const key = document.getElementById('claimKeyInput').value;
            const res = await fetch(`${API}/user/claim_key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key })
            });
            const data = await res.json();
            alert(res.ok ? data.message : data.error);
        }

        async function generateLicense() {
            const duration = document.getElementById('genDuration').value;
            const res = await fetch(`${API}/admin/generate_license`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration })
            });
            const data = await res.json();
            if (res.ok) {
                document.getElementById('adminOutput').innerText = `Generated Key: ${data.key}\n(Copy this now!)`;
            } else {
                alert(data.error);
            }
        }

        async function uploadModel() {
            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files[0];
            if (!file) return alert('Select a file');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', document.getElementById('uploadName').value);
            formData.append('is_public', document.getElementById('uploadPublic').checked);

            const res = await fetch(`${API}/models/upload`, {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                alert('Uploaded!');
                loadModels();
                fileInput.value = '';
            } else {
                alert('Upload failed');
            }
        }

        async function loadModels() {
            const res = await fetch(`${API}/models`);
            const models = await res.json();
            const list = document.getElementById('modelsList');
            list.innerHTML = '';

            models.forEach(m => {
                const div = document.createElement('div');
                div.className = 'model-item';

                let html = `<div>
                <strong>${m.name}</strong> 
                <span style="font-size:0.8em; color:#888">by ${m.owner}</span>`;

                if (m.type === 'public') html += `<span class="tag tag-public">Public</span>`;
                if (m.type === 'shared') html += `<span class="tag tag-shared">Shared</span>`;

                html += `</div>`;

                // Actions
                html += `<div>`;
                if (m.type === 'owned') {
                    html += `<button class="secondary" onclick="shareModel(${m.id})" style="width:auto; padding:5px 10px; font-size:0.8em; margin-right:5px;">Share</button>`;
                }
                // ID needed for download logic in client, but for now just showing existence
                html += `<span style="font-size:0.8em; color:#666">ID: ${m.id}</span>`;
                html += `</div>`;

                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        async function shareModel(id) {
            const user = prompt("Enter username to share with:");
            if (!user) return;

            const days = prompt("Duration (days)?", "30");

            const res = await fetch(`${API}/models/${id}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, days })
            });
            const data = await res.json();
            alert(res.ok ? data.message : data.error);
        }

        // --- Settings ---
        async function updateProfile(type) {
            let body = {};
            if (type === 'email') body.email = document.getElementById('updateEmail').value;
            if (type === 'password') body.password = document.getElementById('updatePass').value;

            const res = await fetch(`${API}/user/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            alert(res.ok ? data.message : data.error);
        }

        async function resetHWID() {
            if (!confirm("Reset Hardware ID linkage?")) return;
            const res = await fetch(`${API}/user/reset_hwid`, { method: 'POST' });
            const data = await res.json();
            alert(data.message || data.error);
        }

        // --- Desktop Admin ---
        async function loadUsers() {
            const res = await fetch(`${API}/admin/users`);
            if (!res.ok) return alert("Failed to load users");
            const users = await res.json();

            const list = document.getElementById('userList');
            list.innerHTML = '';

            // Table Header
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `<tr style="text-align:left"><th>ID</th><th>User</th><th>Email</th><th>Actions</th></tr>`;

            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.username} ${u.is_admin ? 'ðŸ‘‘' : ''}</td>
                    <td>${u.email}</td>
                    <td>
                        <button onclick="resetUserPassword(${u.id})" class="secondary" style="font-size:0.7em; padding:2px 5px; width:auto">Reset Pass</button>
                        ${u.id !== currentUser.id ? `<button onclick="deleteUser(${u.id})" class="danger" style="font-size:0.7em; padding:2px 5px; width:auto">Delete</button>` : ''}
                    </td>
                `;
                table.appendChild(tr);
            });
            list.appendChild(table);
        }

        async function deleteUser(id) {
            if (!confirm("Are you sure? This deletes the user AND their licenses/models!")) return;
            const res = await fetch(`${API}/admin/users/${id}`, { method: 'DELETE' });
            if (res.ok) { loadUsers(); } else { alert((await res.json()).error); }
        }

        async function resetUserPassword(id) {
            if (!confirm("Generate new password for this user?")) return;

            const res = await fetch(`${API}/admin/users/${id}/reset_password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) // No password needed, server generates it
            });
            const data = await res.json();
            if (res.ok) {
                prompt("Password Reset! Send this to the user:", data.new_password);
            } else {
                alert(data.error);
            }
        }

        // Init
        checkSession();
    </script>

</body>

</html>

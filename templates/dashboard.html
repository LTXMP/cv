<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclusive Aim - User Dashboard</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #0f0f13;
            --card-bg: #1a1a20;
            --text: #ffffff;
            --text-dim: #a0a0a0;
            --border: #333;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        h1,
        h2 {
            font-weight: 300;
            letter-spacing: 1px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Auth Wrapper */
        #auth-wrapper {
            display: block;
            /* Default visible */
        }

        #dashboard-wrapper {
            display: none;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Forms */
        input,
        select,
        button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #333;
            background: #25252b;
            color: white;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background-color: #444;
        }

        button.danger {
            background-color: #e74c3c;
        }

        /* Model List */
        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #222;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .tag {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .hidden {
            display: none !important;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Auth Container Styling */
        .section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .sidebar {
            width: 200px;
            background: var(--card-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 80vh;
            border-radius: 12px;
        }

        #dashboard-wrapper {
            display: none;
            gap: 20px;
        }

        .content {
            flex-grow: 1;
        }

        .nav-item {
            text-align: left;
            background: transparent;
            color: var(--text-dim);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transform: translateY(100px);
            transition: transform 0.3s ease-out;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            border-left: 4px solid #2ecc71;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="nav">
            <div>
                <h1 style="color:white; margin:0;">EXCLUSIVE<span style="color:var(--primary)">AIM</span></h1>
            </div>
            <div id="userInfo" style="display:none">
                <span id="usernameDisplay" style="color:var(--text-dim);">User</span>
            </div>
        </header>

        <!-- Auth View -->
        <div id="auth-wrapper">

            <!-- Login Section -->
            <div id="login-section" class="section">
                <!-- User Logo -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: var(--primary); margin: 0;">LOGIN</h2>
                </div>

                <input type="email" id="login-email" placeholder="Email Address">
                <input type="password" id="login-pass" placeholder="Password">
                <div class="row">
                    <button class="btn primary" onclick="login()">Login</button>
                    <button class="btn secondary" onclick="showRegister()">Register</button>
                </div>
                <div style="margin-top: 10px;">
                    <a href="#" onclick="showResetRequest()"
                        style="color: var(--text-dim); font-size: 0.9em; text-decoration: none;">Forgot Password?</a>
                </div>
            </div>

            <!-- Register Section -->
            <div id="register-section" class="section hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: var(--primary); margin: 0;">REGISTER</h2>
                </div>
                <input type="text" id="reg-user" placeholder="Username (for sharing)">
                <input type="email" id="reg-email" placeholder="Email Address">
                <input type="password" id="reg-pass" placeholder="Password">
                <p style="font-size: 0.8em; color: var(--text-dim); text-align: left; margin: 5px 0 15px 0;">
                    Password must be at least 8 characters and contain at least one number or special character.
                </p>
                <div class="row">
                    <button class="btn primary" onclick="register()">Create Account</button>
                    <button class="btn secondary" onclick="showLogin()">Back to Login</button>
                </div>
            </div>

            <!-- Request Reset Section -->
            <div id="reset-request-section" class="section hidden">
                <h2>Reset Password</h2>
                <p style="color:var(--text-dim); font-size:0.9em;">Enter your email to receive a reset link.</p>
                <input type="email" id="reset-email" placeholder="Enter your Email">
                <div class="row">
                    <button class="btn primary" onclick="requestReset()">Send Link</button>
                    <button class="btn secondary" onclick="showLogin()">Back</button>
                </div>
            </div>

            <!-- Perform Reset Section -->
            <div id="reset-perform-section" class="section hidden">
                <h2>Set New Password</h2>
                <input type="hidden" id="reset-token">
                <input type="password" id="new-reset-pass" placeholder="New Password">
                <div class="row">
                    <button class="btn primary" onclick="performReset()">Change Password</button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard (Hidden by default) -->
        <div id="dashboard-wrapper">
            <!-- Sidebar -->
            <div class="sidebar">
                <div
                    style="text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333;">
                    <h3 style="margin:0; color:var(--primary)">EA <span style="color:white">DASH</span></h3>
                </div>
                <button class="nav-item active" onclick="showPage('account')" id="nav-account">Account Settings</button>
                <button class="nav-item" onclick="showPage('models')" id="nav-models">Model Sharing</button>
                <button class="nav-item" onclick="showPage('admin')" id="nav-admin"
                    style="display:none; color:#e056fd;">Admin Panel</button>
                <div style="flex-grow:1"></div>
                <button class="nav-item" onclick="logout()">Logout</button>
            </div>

            <!-- Content Area -->
            <div class="content">

                <!-- Tab: Account Settings -->
                <div id="page-account" class="page active">
                    <h1>Account Settings</h1>

                    <!-- License Status -->
                    <div class="card">
                        <h3>License Status</h3>
                        <p><strong>Status:</strong> <span id="status-license" class="status-invalid">Checking...</span>
                        </p>
                        <p><strong>Expiry:</strong> <span id="status-expiry">-</span></p>

                        <h4>Hardware ID (HWID)</h4>
                        <p style="font-size:0.9em; color:var(--text-dim);">Reset this to use your license on a new
                            PC. (Limit: Once per hour)</p>
                        <button class="btn secondary" onclick="resetHWID()" id="btn-reset-hwid">Reset HWID</button>
                    </div>

                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                        <h4>Redeem License Key</h4>
                        <input type="text" id="license-key-input" placeholder="Enter License Key">
                        <button class="btn primary" onclick="redeemKey()">Activate Key</button>
                    </div>
                    <!-- Profile Settings -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>Edit Profile</h3>
                        <input type="email" id="update-email" placeholder="New Email">
                        <input type="password" id="update-pass" placeholder="New Password">
                        <button class="btn primary" onclick="updateProfile()">Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- Tab: Model Sharing -->
            <div id="page-models" class="page hidden">
                <h1>Model Sharing & Management</h1>

                <!-- Upload Section -->
                <div class="card">
                    <h3>Upload New Model</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Model Name</label>
                            <input type="text" id="upload-name" placeholder="E.g. Titan v1">
                        </div>
                        <div>
                            <label>Model File (.onnx)</label>
                            <input type="file" id="upload-file" accept=".onnx">
                        </div>
                        <div>
                            <label>Model Size</label>
                            <select id="upload-model-size">
                                <option value="Nano">Nano</option>
                                <option value="Small">Small</option>
                                <option value="Medium">Medium</option>
                                <option value="Large">Large</option>
                                <option value="XLarge">XLarge</option>
                            </select>
                        </div>
                        <div>
                            <label>Image Size</label>
                            <select id="upload-img-size">
                                <option value="320">320</option>
                                <option value="416">416</option>
                                <option value="640">640</option>
                                <option value="1280">1280</option>
                            </select>
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Thumbnail (Image)</label>
                            <input type="file" id="upload-thumb" accept="image/*">
                        </div>
                    </div>
                    <button class="btn primary" style="margin-top: 10px;" onclick="uploadModel()">Upload
                        Model</button>
                </div>

                <!-- Models List -->
                <div id="models-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Tab: Admin Panel -->
            <div id="page-admin" class="page hidden">
                <h1>Admin Dashboard</h1>

                <div class="card">
                    <h3>Generate License Key</h3>
                    <div class="row">
                        <select id="gen-duration">
                            <option value="LIFETIME">Lifetime</option>
                            <option value="2592000">30 Days</option>
                            <option value="86400">1 Day</option>
                        </select>
                        <button class="btn primary" onclick="generateLicense()">Generate Key</button>
                    </div>
                    <div id="gen-result"
                        style="margin-top:15px; display:none; background:#222; padding:10px; border-radius:6px;">
                        <p style="margin:0; color:var(--text-dim);">Generated Key:</p>
                        <code id="new-license-key"
                            style="font-size:1.2em; color:#2ecc71; display:block; margin:5px 0;"></code>
                    </div>
                </div>

                <div class="card">
                    <h3>Unclaimed Licenses</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; color:var(--text-dim); text-align:left;">
                            <thead>
                                <tr style="border-bottom:1px solid #333; cursor:pointer;">
                                    <th style="padding:10px;" onclick="sortLicenses('key')">Key ↕</th>
                                    <th style="padding:10px;" onclick="sortLicenses('duration')">Duration ↕</th>
                                </tr>
                            </thead>
                            <tbody id="admin-licenses-list">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>User Management</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; color:var(--text-dim); text-align:left;">
                            <thead>
                                <tr style="border-bottom:1px solid #333;">
                                    <th style="padding:10px;">ID</th>
                                    <th style="padding:10px;">User (Hover for Info)</th>
                                    <th style="padding:10px;">Status</th>
                                    <th style="padding:10px;">Role</th>
                                    <th style="padding:10px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-list">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>System Models (All)</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; color:var(--text-dim); text-align:left;">
                            <thead>
                                <tr style="border-bottom:1px solid #333;">
                                    <th style="padding:10px;">ID</th>
                                    <th style="padding:10px;">Name</th>
                                    <th style="padding:10px;">Owner</th>
                                    <th style="padding:10px;">Visibility</th>
                                    <th style="padding:10px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-models-list">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ... (Notification div remains) ... -->
    <div id="notification" class="notification"></div>

    <script>
        // ... (Existing variables) ...
        const API_URL = '/api';

        // --- Admin Functions ---

        async function loadAdminData() {
            loadAdminUsers();
            loadAdminModels();
            loadAdminLicenses();
        }

        let adminLicenses = []; // Store for sorting
        let sortDir = 1; // 1 asc, -1 desc

        async function loadAdminLicenses() {
            try {
                const res = await fetch(`${API_URL}/admin/licenses`);
                adminLicenses = await res.json();
                renderLicenses(adminLicenses);
            } catch (e) {
                console.error("Failed to load licenses", e);
            }
        }

        function renderLicenses(list) {
            const tbody = document.getElementById('admin-licenses-list');
            tbody.innerHTML = '';
            list.forEach(l => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #333';
                tr.innerHTML = `
                    <td style="padding:10px; font-family:monospace; color:#2ecc71;">${l.key}</td>
                    <td style="padding:10px;">${l.duration}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function sortLicenses(col) {
            sortDir *= -1; // Toggle
            adminLicenses.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];

                // Map Duration Strings to values for sorting if needed
                if (col === 'duration') {
                    if (valA === 'LIFETIME') valA = 9999999999;
                    else valA = parseInt(valA);
                    if (valB === 'LIFETIME') valB = 9999999999;
                    else valB = parseInt(valB);
                }

                if (valA < valB) return -1 * sortDir;
                if (valA > valB) return 1 * sortDir;
                return 0;
            });
            renderLicenses(adminLicenses);
        }

        async function loadAdminUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`);
                const users = await res.json();
                const tbody = document.getElementById('admin-users-list');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #333';

                    const banStatus = u.is_banned ? '<span class="tag" style="background:#e74c3c">BANNED</span>' : '<span class="tag" style="background:#2ecc71">Active</span>';
                    const tooltip = `Email: ${u.email}\nLast IP: ${u.last_ip || 'None'}\nCreated: ${new Date(u.created_at * 1000).toLocaleDateString()}`;

                    tr.innerHTML = `
                        <td style="padding:10px;">${u.id}</td>
                        <td style="padding:10px;" title="${tooltip}">
                            <span style="border-bottom:1px dotted #777; cursor:help;">${u.username}</span>
                        </td>
                        <td style="padding:10px;">${banStatus}</td>
                        <td style="padding:10px;">${u.is_admin ? 'ADMIN' : 'User'}</td>
                        <td style="padding:10px; display:flex; gap:5px; flex-wrap:wrap;">
                            ${!u.is_admin ? `
                                <button class="btn secondary" style="padding:5px; font-size:0.75em;" onclick="adminResetPass(${u.id})">Reset PW</button>
                                ${u.is_banned ?
                                `<button class="btn primary" style="padding:5px; font-size:0.75em;" onclick="adminUnbanUser(${u.id})">Unban</button>` :
                                `<button class="btn danger" style="padding:5px; font-size:0.75em;" onclick="adminBanUser(${u.id})">Ban</button>`}
                                <button class="btn danger" style="padding:5px; font-size:0.75em;" onclick="adminBanIP('${u.last_ip}')">Ban IP</button>
                                <button class="btn danger" style="padding:5px; font-size:0.75em;" onclick="adminDeleteUser(${u.id}, '${u.username}')">X</button>
                            ` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Failed to load users", e);
            }
        }

        async function adminBanUser(id) {
            if (!confirm("Ban this user?")) return;
            const res = await fetch(`${API_URL}/admin/users/${id}/ban`, { method: 'POST' });
            if (res.ok) { showNotification("User Banned", "success"); loadAdminUsers(); }
        }

        async function adminUnbanUser(id) {
            if (!confirm("Unban this user?")) return;
            const res = await fetch(`${API_URL}/admin/users/${id}/unban`, { method: 'POST' });
            if (res.ok) { showNotification("User Unbanned", "success"); loadAdminUsers(); }
        }

        async function adminResetPass(id) {
            if (!confirm("Reset user password to 'ChangeMe123!'?")) return;
            const res = await fetch(`${API_URL}/admin/users/${id}/reset_pass`, { method: 'POST' });
            const data = await res.json();
            if (res.ok) { alert(data.message); }
        }

        async function adminBanIP(ip) {
            if (!ip || ip === 'null' || ip === 'None') { alert("No IP recorded for user."); return; }
            if (!confirm(`Ban IP Address ${ip}?`)) return;
            const res = await fetch(`${API_URL}/admin/ip_ban`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip })
            });
            if (res.ok) { showNotification("IP Banned", "success"); }
        }

        async function adminDeleteUser(id, name) {
            if (!confirm(`Are you sure you want to PERMANENTLY delete user '${name}'? This will delete all their models and licenses.`)) return;

            const res = await fetch(`${API_URL}/admin/users/${id}/delete`, { method: 'POST' }); // Using POST for safety if DELETE is blocked by some proxies
            if (res.ok) {
                showNotification('User Deleted', 'success');
                loadAdminUsers();
                loadAdminModels();
            } else {
                showNotification('Failed to delete user', 'error');
            }
        }

        async function loadAdminModels() {
            try {
                const res = await fetch(`${API_URL}/admin/models`);
                const models = await res.json();
                const tbody = document.getElementById('admin-models-list');
                tbody.innerHTML = '';

                models.forEach(m => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #333';
                    tr.innerHTML = `
                        <td style="padding:10px;">${m.id}</td>
                        <td style="padding:10px;">${m.name}</td>
                        <td style="padding:10px;">${m.owner_username}</td>
                        <td style="padding:10px;">
                             ${m.is_public ? '<span style="color:#2ecc71">Public</span>' : '<span style="color:#e74c3c">Private</span>'}
                        </td>
                        <td style="padding:10px; display:flex; gap:5px;">
                            <button class="btn secondary" style="padding:5px; font-size:0.75em;" onclick="adminToggleModel(${m.id}, ${m.is_public})">
                                ${m.is_public ? 'Unpublish' : 'Publish'}
                            </button>
                            <button class="btn danger" style="padding:5px; font-size:0.75em;" onclick="adminDeleteModel(${m.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Failed to load all models", e);
            }
        }

        }

        // --- Device Config Functions ---

        async function loadDeviceConfig() {
            try {
                const res = await fetch(`${API_URL}/config`);
                const config = await res.json();

                if (config.activation_mode) document.getElementById('cfg-activation-mode').value = config.activation_mode;
                if (config.btn_ads) document.getElementById('cfg-btn-ads').value = config.btn_ads;
                if (config.btn_shoot) document.getElementById('cfg-btn-shoot').value = config.btn_shoot;
                if (config.output_protocol) document.getElementById('cfg-output-protocol').value = config.output_protocol;

                document.getElementById('cfg-mnk-support').checked = !!config.mnk_support;
                document.getElementById('cfg-1000hz').checked = !!config.force_1000hz;
                document.getElementById('cfg-edgefix').checked = !!config.edgefix;

                // Mock Device List
                const devSel = document.getElementById('cfg-device-selector');
                devSel.innerHTML = '<option value="titan_two">Titan Two [0x2508:0x0032]</option>';

            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        async function saveDeviceConfig() {
            const config = {
                activation_mode: document.getElementById('cfg-activation-mode').value,
                btn_ads: document.getElementById('cfg-btn-ads').value,
                btn_shoot: document.getElementById('cfg-btn-shoot').value,
                output_protocol: document.getElementById('cfg-output-protocol').value,
                mnk_support: document.getElementById('cfg-mnk-support').checked,
                force_1000hz: document.getElementById('cfg-1000hz').checked,
                edgefix: document.getElementById('cfg-edgefix').checked
            };

            try {
                const res = await fetch(`${API_URL}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (res.ok) showNotification("Configuration Saved!", "success");
                else showNotification("Failed to save config.", "error");
            } catch (e) {
                console.error("Save failed", e);
            }
        }

        function refreshDevices() {
            showNotification("Scanning for devices...", "info");
        }

        async function adminToggleModel(id, current) {
            const action = current ? 'private' : 'public';
            const res = await fetch(`${API_URL}/admin/models/${id}/publish`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            });
            if (res.ok) { loadAdminModels(); }
        }

        async function adminDeleteModel(id) {
            if (!confirm("Delete this model?")) return;
            const res = await fetch(`${API_URL}/admin/models/${id}/delete`, { method: 'POST' });
            if (res.ok) {
                showNotification('Model Deleted', 'success');
                loadAdminModels();
            } else {
                showNotification('Failed to delete model', 'error');
            }
        }

        // Generate License Wrapper to refresh list
        const originalGen = window.generateLicense;
        window.generateLicense = async function () {
            const duration = document.getElementById('gen-duration').value;
            const res = await fetch(`${API_URL}/admin/generate_license`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration })
            });
            const data = await res.json();
            if (data.key) {
                document.getElementById('new-license-key').innerText = data.key;
                document.getElementById('gen-result').style.display = 'block';
                loadAdminLicenses(); // Refresh list
            }
        }




        // --- Auth Functions --- //

        async function login() {
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-pass').value;

                console.log("Attempting login...");
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    console.log("Login OK, saving token and reloading...");

                    if (!data.username) {
                        alert("CRITICAL: Server returned login success but NO USERNAME!\nData: " + JSON.stringify(data));
                        return;
                    }

                    localStorage.setItem('username', data.username);
                    localStorage.setItem('isAdmin', data.is_admin);

                    alert(`Login Success! Saving User: ${data.username}\nReloading now...`);
                    window.location.reload();
                } else {
                    showNotification(data.error || 'Login Failed', 'error');
                }
            } catch (e) {
                alert("Login Critical Error: " + e);
                console.error(e);
            }
        }

        async function register() {
            const username = document.getElementById('reg-user').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });
            const data = await res.json();

            if (res.ok) {
                showNotification('Account Created! Please Login.', 'success');
                showLogin();
            } else {
                showNotification(data.error || 'Registration Failed', 'error');
            }
        }

        async function logout() {
            // Clear credentials IMMEDIATELY so we don't get stuck loop
            localStorage.removeItem('username');
            localStorage.removeItem('isAdmin');

            try {
                await fetch(`${API_URL}/logout`, { method: 'POST' });
            } catch (e) {
                console.error("Logout fetch failed", e);
            }

            // Force reload to clear memory state
            window.location.reload();
        }

        // ...

        // --- UI Navigation Helper Functions (Restoring Missing Code) ---

        function hideAll() {
            document.getElementById('auth-wrapper').style.display = 'none';
            document.getElementById('dashboard-wrapper').style.display = 'none';
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('reset-request-section').classList.add('hidden');
            document.getElementById('reset-perform-section').classList.add('hidden');
        }

        function showLogin() {
            hideAll();
            document.getElementById('auth-wrapper').style.display = 'block';
            document.getElementById('login-section').classList.remove('hidden');
        }

        function showRegister() {
            hideAll();
            document.getElementById('auth-wrapper').style.display = 'block';
            document.getElementById('register-section').classList.remove('hidden');
        }

        function showDashboard(username, isAdmin) {
            hideAll();
            document.getElementById('dashboard-wrapper').style.display = 'flex';

            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('usernameDisplay').innerText = username + (isAdmin ? " [ADMIN]" : "");

            if (isAdmin) {
                document.getElementById('nav-admin').style.display = 'block';
            }

            // Initial load
            showPage('account');
            loadAccountData();
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // Show target
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`page-${pageId}`).classList.add('active');

            // Highlight nav
            const navBtn = document.getElementById(`nav-${pageId}`);
            if (navBtn) navBtn.classList.add('active');

            if (pageId === 'models') {
                loadModels();
            }
            if (pageId === 'admin') {
                loadAdminData();
            }
        }

        async function loadAccountData() {
            try {
                const res = await fetch(`${API_URL}/user/license`);
                if (res.status === 401) {
                    // Session expired
                    logout();
                    return;
                }

                const data = await res.json();

                const statusEl = document.getElementById('status-license');
                const expiryEl = document.getElementById('status-expiry');

                if (data.status === 'Active') {
                    statusEl.innerText = `${data.status} (${data.type})`;
                    statusEl.className = "status-active";
                    statusEl.style.color = "#2ecc71";
                    expiryEl.innerText = data.expiry;
                } else {
                    statusEl.innerText = "Inactive / No License";
                    statusEl.className = "status-invalid";
                    statusEl.style.color = "#e74c3c";
                    expiryEl.innerText = "-";
                }
            } catch (e) {
                console.error("Failed to load license:", e);
                document.getElementById('status-license').innerText = "Error Loading";
            }
        }

        async function updateProfile() {
            const email = document.getElementById('update-email').value;
            const password = document.getElementById('update-pass').value;

            const body = {};
            if (email) body.email = email;
            if (password) body.password = password;

            if (Object.keys(body).length === 0) {
                showNotification('No changes to save.', 'info');
                return;
            }

            const res = await fetch(`${API_URL}/user/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (res.ok) {
                showNotification('Profile Updated', 'success');
                document.getElementById('update-pass').value = '';
                document.getElementById('update-email').value = '';
            } else {
                showNotification(data.error, 'error');
            }
        }

        async function redeemKey() {
            const key = document.getElementById('license-key-input').value;
            if (!key) return showNotification('Please enter a key', 'error');

            const res = await fetch(`${API_URL}/user/claim_key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key })
            });
            const data = await res.json();

            if (res.ok) {
                showNotification('License Activated!', 'success');
                loadAccountData(); // Refresh status
                document.getElementById('license-key-input').value = '';
            } else {
                showNotification(data.error, 'error');
            }
        }

        async function resetHWID() {
            if (!confirm("Are you sure? You can only do this once per hour.")) return;

            const res = await fetch(`${API_URL}/user/reset_hwid`, { method: 'POST' });
            const data = await res.json();

            if (res.ok) {
                showNotification('HWID Reset Successful', 'success');
            } else {
                showNotification(data.error, 'error');
            }
        }

        // --- Model Functions ---

        async function loadModels() {
            const res = await fetch(`${API_URL}/models`);
            const data = await res.json();
            const list = document.getElementById('models-list');
            list.innerHTML = '';

            // Own Models
            if (data.own && data.own.length > 0) {
                const ownHeader = document.createElement('h3');
                ownHeader.innerText = "My Models";
                list.appendChild(ownHeader);

                data.own.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card model-item';
                    card.style.display = 'flex';
                    card.style.gap = '15px';
                    card.style.alignItems = 'center';
                    // Model Metadata
                    const thumb = m.thumbnail_path || '';

                    let thumbHtml = '';
                    if (thumb) {
                        thumbHtml = `<img src="${thumb}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">`;
                    } else {
                        thumbHtml = `<div style="width: 80px; height: 80px; background: #333; border-radius: 8px; display:flex; align-items:center; justify-content:center; color:#555; font-size:0.8em;">No Img</div>`;
                    }

                    card.innerHTML = `
                    ${thumbHtml}
                    <div style="flex-grow: 1;">
                        <h3 style="margin: 0;">${m.name} <span style="font-size:0.8em; color:var(--primary);">#${m.unique_id}</span></h3>
                        <p style="font-size: 0.9em; color: var(--text-dim); margin: 5px 0;">
                            Size: ${m.model_size} | Img: ${m.image_size}
                        </p>
                        <div class="row" style="margin-top:10px; gap:10px;">
                            <button class="btn secondary" onclick="openShareModal(${m.id})">Share</button>
                            <button class="btn secondary" onclick="replaceModel(${m.id})">Replace File</button>
                            <button class="btn danger" onclick="deleteModel(${m.id})">Delete</button>
                        </div>
                    </div>
                `;
                    list.appendChild(card);
                });
            }


            // Shared Models
            if (data.shared && data.shared.length > 0) {
                const header = document.createElement('h3');
                header.innerText = "Shared With Me";
                header.style.marginTop = "20px";
                list.appendChild(header);

                data.shared.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h4>${m.name} <span style="font-size:0.8em; color:var(--text-dim);">#${m.unique_id}</span></h4>
                         <p style="font-size: 0.9em; color: var(--text-dim);">Shared by ${m.owner_username}</p>
                    `;
                    list.appendChild(card);
                });
            }

            if ((!data.own || data.own.length === 0) && (!data.shared || data.shared.length === 0)) {
                list.innerHTML = '<p>No models found. Upload one to get started!</p>';
            }
        }

        async function uploadModel() {
            const file = document.getElementById('upload-file').files[0];
            const name = document.getElementById('upload-name').value;
            const modelSize = document.getElementById('upload-model-size').value;
            const imgSize = document.getElementById('upload-img-size').value;
            const thumb = document.getElementById('upload-thumb').files[0];

            if (!file || !name) {
                showNotification('Please select a file and name.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            formData.append('model_size', modelSize);
            formData.append('image_size', imgSize);
            if (thumb) formData.append('thumbnail', thumb);

            showNotification('Uploading...', 'info');

            const res = await fetch(`${API_URL}/models/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                showNotification('Upload Successful', 'success');
                loadModels();
                // Clear form
                document.getElementById('upload-file').value = '';
                document.getElementById('upload-name').value = '';
                document.getElementById('upload-thumb').value = '';
            } else {
                showNotification(data.error || 'Upload Failed', 'error');
            }
        }

        async function deleteModel(id) {
            if (!confirm("Are you sure you want to delete this model?")) return;
            const res = await fetch(`${API_URL}/models/${id}/delete`, { method: 'DELETE' });
            if (res.ok) {
                showNotification('Model Deleted', 'success');
                loadModels();
            } else {
                showNotification('Delete Failed', 'error');
            }
        }

        async function replaceModel(id) {
            // Create a hidden file input to trigger selection
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.onnx';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                showNotification('Replacing file...', 'info');
                const res = await fetch(`${API_URL}/models/${id}/replace`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    showNotification('Model File Replaced', 'success');
                } else {
                    const data = await res.json();
                    showNotification(data.error || 'Replace Failed', 'error');
                }
            };
            input.click();
        }

        // --- Sharing Logic ---

        function openShareModal(modelId) {
            // Simplified "Modal" using prompts for now to save UI complexity
            // In a full implementation, build a proper overlay div

            // 1. Search User
            const username = prompt("Enter username to share with:");
            if (!username) return;

            // 2. Select Duration
            const durationStr = prompt("Enter duration in days (leave empty for Permanent):");
            let expiry = null;
            if (durationStr) {
                const days = parseFloat(durationStr);
                if (!isNaN(days)) {
                    // Current Time + Days * Seconds in Day
                    expiry = (Date.now() / 1000) + (days * 86400);
                }
            }

            shareModel(modelId, username, expiry);
        }

        async function shareModel(modelId, username, expiry) {
            const res = await fetch(`${API_URL}/models/${modelId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, expiry })
            });
            const data = await res.json();

            if (res.ok) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.error, 'error');
            }
        }

        // --- Notifications ---

        function showNotification(msg, type = 'info') {
            const notif = document.getElementById('notification');
            notif.innerText = msg;
            notif.className = `notification ${type} show`;
            setTimeout(() => {
                notif.className = 'notification';
            }, 3000);
        }

        // --- Init ---

        // Check session on load
        // Check session on load
        (async () => {
            try {
                // DEBUG: Check what we actually have
                const u = localStorage.getItem('username');
                const admin = localStorage.getItem('isAdmin');

                // alert(`DEBUG STARTUP:\nUser: ${u}\nAdmin: ${admin}`); // Uncomment if needed, but let's try to just log first unless it fails hard

                if (u && u !== "undefined" && u !== "null") {
                    console.log("Found user, showing dashboard...");
                    try {
                        showDashboard(u, admin === 'true');
                    } catch (e) {
                        alert("CRITICAL ERROR in showDashboard: " + e);
                        console.error(e);
                    }
                } else {
                    console.log("No user found, showing login.");
                    showLogin();
                }

                // Check for Reset Token
                const urlParams = new URLSearchParams(window.location.search);
                const resetToken = urlParams.get('reset_token');
                if (resetToken) {
                    showResetPerform(resetToken);
                }
            } catch (err) {
                alert("CRITICAL STARTUP ERROR: " + err);
            }
        })();

        async function requestReset() {
            const email = document.getElementById('reset-email').value;
            const res = await fetch(`${API_URL}/auth/request_reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();
            showNotification(data.message || data.error, res.ok ? 'success' : 'error');
        }

        async function performReset() {
            const token = document.getElementById('reset-token').value;
            const password = document.getElementById('new-reset-pass').value;

            const res = await fetch(`${API_URL}/auth/reset_password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, password })
            });
            const data = await res.json();

            if (res.ok) {
                showNotification('Password Changed! Please Login.', 'success');
                showLogin();
            } else {
                showNotification(data.error || 'Failed', 'error');
            }
        }

        function showResetRequest() {
            hideAll();
            document.getElementById('reset-request-section').classList.remove('hidden');
            document.getElementById('auth-wrapper').style.display = 'block';
        }

        function showResetPerform(token) {
            hideAll();
            document.getElementById('reset-token').value = token;
            document.getElementById('reset-perform-section').classList.remove('hidden');
            document.getElementById('auth-wrapper').style.display = 'block';
        }

    </script>
</body>

</html>